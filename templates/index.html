<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <title>Peľová Analýza Vegetácie v Trnave</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        :root {
            --bg: #05060a;
            --bg-elevated: #0b1020;
            --card: #111827;
            --border: #1f2937;
            --accent: #22c55e;
            --accent-soft: rgba(34, 197, 94, 0.12);
            --text: #e5e7eb;
            --muted: #9ca3af;
            --danger: #ef4444;
            --font: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            background: radial-gradient(circle at top, #020617 0, #020617 35%, #000 100%);
            color: var(--text);
            font-family: var(--font);
            min-height: 100vh;
        }

        .page {
            max-width: 1120px;
            margin: 0 auto;
            padding: 24px 16px 40px;
        }

        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            padding: 8px 0 24px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo-mark {
            width: 28px;
            height: 28px;
            border-radius: 10px;
            background: conic-gradient(from 210deg, #22c55e, #4ade80, #22c55e);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 18px rgba(34, 197, 94, 0.55);
        }

        .logo-mark span {
            font-size: 16px;
            font-weight: 700;
            color: #020617;
        }

        .logo-text-main {
            font-size: 18px;
            font-weight: 600;
            letter-spacing: 0.03em;
        }

        .logo-text-sub {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.14em;
            color: var(--muted);
        }

        .tagline {
            font-size: 12px;
            color: var(--muted);
            text-align: right;
        }

        .tagline span {
            color: var(--accent);
        }

        .hero {
            border-radius: 18px;
            background: radial-gradient(circle at top left, rgba(34, 197, 94, 0.16), transparent 55%),
            radial-gradient(circle at top right, rgba(52, 211, 153, 0.08), transparent 60%),
            var(--bg-elevated);
            border: 1px solid rgba(148, 163, 184, 0.14);
            padding: 22px 20px 18px;
            box-shadow: 0 18px 60px rgba(15, 23, 42, 0.75);
        }

        .hero-title {
            font-size: clamp(26px, 3.1vw, 32px);
            line-height: 1.1;
            font-weight: 650;
            margin-bottom: 8px;
        }

        .hero-highlight {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 3px 9px;
            border-radius: 999px;
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid rgba(34, 197, 94, 0.45);
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.14em;
            color: var(--muted);
            margin-bottom: 8px;
        }

        .hero-highlight-dot {
            width: 7px;
            height: 7px;
            border-radius: 999px;
            background: var(--accent);
            box-shadow: 0 0 10px rgba(34, 197, 94, 0.9);
        }

        .hero-subtitle {
            font-size: 13px;
            color: var(--muted);
            max-width: 600px;
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .hero-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 14px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            font-size: 11px;
            color: var(--muted);
        }

        .control-group label {
            text-transform: uppercase;
            letter-spacing: 0.14em;
        }

        .control-input {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 7px 12px;
            background: rgba(15, 23, 42, 0.95);
            border-radius: 10px;
            border: 1px solid rgba(148, 163, 184, 0.35);
            font-size: 13px;
            color: var(--text);
        }

        select, button {
            font-family: inherit;
            font-size: 13px;
            border: none;
            background: transparent;
            color: inherit;
            outline: none;
            width: 100%;
        }

        .year-checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 8px;
            background: rgba(15, 23, 42, 0.95);
            border-radius: 10px;
            border: 1px solid rgba(148, 163, 184, 0.35);
            max-height: 120px;
            overflow-y: auto;
        }

        .year-checkbox {
            display: flex;
            align-items: center;
        }

        .year-checkbox input {
            display: none;
        }

        .year-checkbox label {
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 12px;
            cursor: pointer;
            border: 1px solid var(--border);
            transition: all 0.2s ease;
        }

        .year-checkbox input:checked + label {
            background: var(--accent-soft);
            color: var(--accent);
            border-color: rgba(34, 197, 94, 0.45);
        }

        #season-info {
            font-size: 11px;
            color: var(--muted);
            margin-top: 4px;
            padding-left: 5px;
            min-height: 1.2em;
        }

        .button-group {
            align-self: end;
        }

        button.primary {
            background: linear-gradient(125deg, #22c55e, #4ade80);
            color: #022c22;
            border-radius: 999px;
            padding: 12px 20px;
            font-weight: 600;
            letter-spacing: 0.04em;
            text-transform: uppercase;
            font-size: 12px;
            cursor: pointer;
            border: none;
            box-shadow: 0 15px 40px rgba(16, 185, 129, 0.35);
            transition: all 0.2s ease;
        }

        button.primary:hover {
            filter: brightness(1.1);
            transform: translateY(-1px);
        }

        button:disabled {
            cursor: not-allowed;
            background: var(--border);
            color: var(--muted);
            box-shadow: none;
        }

        .results-section {
            margin-top: 24px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 400px;
            background: var(--card);
            border-radius: 16px;
            border: 1px solid var(--border);
            padding: 20px;
            box-shadow: 0 16px 40px rgba(15, 23, 42, 0.85);
            text-align: center;
        }

        .results-section img {
            max-width: 100%;
            border-radius: 10px;
            border: 1px solid var(--border);
        }

        .placeholder-text {
            color: var(--muted);
            font-size: 14px;
        }

        .error-message {
            color: var(--danger);
            background-color: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--danger);
            padding: 10px 15px;
            border-radius: 10px;
            max-width: 600px;
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-left-color: var(--accent);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .card {
            background: var(--card);
            border-radius: 16px;
            border: 1px solid var(--border);
            padding: 14px 14px 13px;
            margin-top: 24px;
        }

        .card-header {
            margin-bottom: 10px;
        }

        .card-title {
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.16em;
            color: var(--muted);
        }

        .card-body p {
            font-size: 12px;
            color: var(--muted);
            line-height: 1.6;
        }

        .button-flexbox {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
        }
        option{
            background-color: var(--bg-elevated);
        }
    </style>
</head>
<body>
<div class="page">
    <header>
        <div class="logo">
            <div class="logo-mark"><span>T</span></div>
            <div>
                <div class="logo-text-main">Peľová Analýza Trnavy</div>
                <div class="logo-text-sub">Sentinel-2 · NDVI Trendy</div>
            </div>
        </div>
        <div class="tagline">
            Analýza dlhodobých trendov vegetácie<br>
            <span>Spracované pomocou Sentinel Hub API</span>
        </div>
    </header>

    <main>
        <section class="hero">
            <div class="hero-highlight">
                <div class="hero-highlight-dot"></div>
                <span>Trnava · Analýza peľových sezón</span>
            </div>
            <div class="button-flexbox">
                <button class="primary load-veg-btn">Zmena vegetácie</button>
                <button class="primary load-pollen-btn">Nástup peľovej sezóny</button>
                <button class="primary load-curr-poll-btn">Aktuálna peľová situácia</button>
            </div>
            <div class="content-div">

            </div>
        </section>


        <article class="card">
            <div class="card-header">
                <h2 class="card-title">Metodika</h2>
            </div>
            <div class="card-body">
                <p>
                    Využívame voľne dostupné dáta z programu Copernicus (satelity Sentinel-2, L2A). Pre každý zvolený
                    rok a obdobie sa stiahnu snímky s najnižšou oblačnosťou. Z pásiem B8 (blízke infračervené) a B4
                    (červené) sa vypočíta NDVI, ktorý je dobrým indikátorom množstva a zdravia vegetácie. Následne sa
                    pomocou lineárnej regresie vypočíta trend pre každý pixel na mape.
                </p>
                <p>
                    Výsledkom je mapa, kde <strong>zelená farba</strong> indikuje pribúdanie vegetácie (potenciálne viac
                    alergénov), <strong>červená</strong> úbytok a <strong>biela</strong> stabilný stav.
                </p>
            </div>
        </article>
    </main>
</div>

<script>
    function loadVegetaciu(contentDiv) {
        contentDiv.innerHTML = `
        <h1 class="hero-title">Ako sa mení vegetácia počas peľových sezón?</h1>
                <p class="hero-subtitle">
                    Zvoľte si roky a peľovú sezónu pre analýzu. Nástroj vyhodnotí zeleň (NDVI) v danom období a porovná jej vývoj naprieč rokmi, čo môže pomôcť identifikovať zmeny v intenzite peľových alergénov.
                </p>

                <div class="hero-controls">
                    <div class="control-group">
                        <label for="year-select">Vyberte roky (aspoň dva)</label>
                        <div id="year-checkbox-container" class="year-checkbox-group">
                            <!-- Checkboxy rokov budú dynamicky vložené cez JS -->
                        </div>
                    </div>
                    <div class="control-group">
                        <label for="season-select">Peľová sezóna</label>
                        <div class="control-input">
                            <select id="season-select">
                                <option value="early_spring">Skorá jar (Feb-Mar)</option>
                                <option value="mid_spring">Stredná jar (Apr-Máj)</option>
                                <option value="late_spring" selected>Neskorá jar / Leto (Jún-Aug)</option>
                                <option value="year">Celý rok</option>
                            </select>
                        </div>
                        <div id="season-info"></div>
                    </div>
                    <div class="control-group button-group">
                        <label>&nbsp;</label>
                        <button class="primary" id="analyze-btn">Analyzovať trend</button>
                    </div>
                </div>
                <section id="results" class="results-section">
                    <div class="placeholder-text">Výsledná mapa trendu sa zobrazí tu.</div>
                </section>
        `;
    }

    function loadPollenSeason(contentDiv) {
        contentDiv.innerHTML = `
               <h1 class="hero-title">Nástup peľovej sezóny</h1>
                <p class="hero-subtitle">
                    Analyzujte zmeny vegetácie počas peľových sezón v Trnave v rôznych oblastiach. Vyberte oblasť, aby ste zistili, ako sa mení množstvo zelene, čo môže indikovať intenzitu peľových alergénov.
                </p>

                <div class="hero-controls">
                    <div class="control-group">
                        <label for="location-select">Nástup peľovej sezóny</label>
                        <div class="control-input">
                            <select id="location-select">
                                <option value="janka-krala">Park Janka Kráľa</option>
                                <option value="nemocnicny">Nemocničný park</option>
                                <option value="strky" selected>Štrky</option>
                                <option value="druzba">Park za družbou</option>
                                <option value="zahradkarska">Záhradkárska oblasť</option>
                                <option value="kamenac">Kamenáč</option>
                                <option value="rybniky">Rybníky</option>
                                </select>
                        </div>
                    </div>
                    <div class="control-group">
                        <label>&nbsp;</label>
                        <button class="primary analyze-polen" id="analyze-polen-btn">Zobraziť vývoj peľovej sezóny</button>
                    </div>
                </div>
                <section id="results" class="results-section">
                    <div class="placeholder-text">Výsledná mapa trendu sa zobrazí tu.</div>
                </section>`;
    }

    async function loadCurrentPollen(contentDiv) {
        contentDiv.innerHTML = `
               <h1 class="hero-title">Aktuálna peľová situácia</h1>
                <p class="hero-subtitle">
                    Aktuálne koncentrácie peľu za tento rok. Keďže analýza peľových údajov je zložitá a časovo náročná, nie je možné ju zobraziť v reálnom čase. Grafy budú aktualizované, keď budú k dispozícii nové údaje.
                </p>
                <section id="results austria-graph" class="results-section">
                    
                </section>`;

        // Load the Austria pollen graph
        try{
            const response = await fetch('/api/current_pollen');
            const data = await response.json();
            if (!response.ok) {
                throw new Error(data.error || `HTTP error! Status: ${response.status}`);
            }
            const resultsSection = document.getElementById('results austria-graph');
            if (resultsSection) {
                const pollenGraphs = JSON.parse(data.pollen_data);
                renderPollenPlots(pollenGraphs);

            }
        }catch(error){
            console.error('Error loading current pollen data:', error);
            showError(`Chyba pri načítaní aktuálnych peľových údajov: ${error.message}`);
        }
    }

    const content = document.querySelector('.content-div');

    // Define pollenInfo at the top before any functions use it
    const pollenInfo = {
        early_spring: "Hlavné alergény: Lieska, Jelša, Tis.",
        mid_spring: "Hlavné alergény: Javor, Jaseň, Bresty.",
        late_spring: "Hlavné alergény: Pagaštan, Lipa, trávy.",
        year: "Analýza pre celý kalendárny rok."
    };

    // Load vegetation analysis by default on page load
    loadVegetaciu(content);
    let yearContainer = document.getElementById('year-checkbox-container');
    populateYearCheckboxes(yearContainer);

    // Attach event listeners for initial load
    attachVegetationListeners();

    const vegBtn = document.querySelector('.load-veg-btn');
    vegBtn.addEventListener('click', () => {
        loadVegetaciu(content);
        yearContainer = document.getElementById('year-checkbox-container');
        populateYearCheckboxes(yearContainer);
        attachVegetationListeners();
    });

    const pollenBtn = document.querySelector('.load-pollen-btn');
    pollenBtn.addEventListener('click', () => {
        loadPollenSeason(content);
        attachPollenListeners();
    });

    const currPollenBtn = document.querySelector('.load-curr-poll-btn');
    currPollenBtn.addEventListener('click', () => {
        loadCurrentPollen(content);
    });

    function attachVegetationListeners() {
        const analyzeBtn = document.getElementById('analyze-btn');
        const seasonSelect = document.getElementById('season-select');

        if (analyzeBtn) {
            analyzeBtn.addEventListener('click', handleAnalysis);
        }
        if (seasonSelect) {
            seasonSelect.addEventListener('change', updateSeasonInfo);
            updateSeasonInfo();
        }
    }

    function attachPollenListeners() {
        const analyzePolenBtn = document.getElementById('analyze-polen-btn');
        if (analyzePolenBtn) {
            analyzePolenBtn.addEventListener('click', handlePollenAnalysis);
        }
    }



    // Populácia rokov ako checkboxy
    function populateYearCheckboxes(yearContainer) {
        const currentYear = new Date().getFullYear();
        for (let year = currentYear; year >= 2017; year--) {
            const div = document.createElement('div');
            div.className = 'year-checkbox';
            const input = document.createElement('input');
            input.type = 'checkbox';
            input.id = `year-${year}`;
            input.value = year;
            // Predvolene vyberieme posledné dva roky
            if (year === currentYear || year === currentYear - 1) {
                input.checked = true;
            }
            const label = document.createElement('label');
            label.htmlFor = `year-${year}`;
            label.textContent = year;
            div.appendChild(input);
            div.appendChild(label);
            yearContainer.appendChild(div);
        }
    }

    function updateSeasonInfo() {
        const seasonSelect = document.getElementById('season-select');
        const seasonInfo = document.getElementById('season-info');
        if (seasonSelect && seasonInfo) {
            const selectedSeason = seasonSelect.value;
            seasonInfo.textContent = pollenInfo[selectedSeason] || "";
        }
    }

    async function handlePollenAnalysis() {

        const locationSelect = document.getElementById('location-select');
        const resultsSection = document.getElementById('results');
        const analyzePolenBtn = document.getElementById('analyze-polen-btn');

        const selectedLocation = locationSelect.value;

        showLoading();
        if (analyzePolenBtn) {
            analyzePolenBtn.disabled = true;
            analyzePolenBtn.textContent = 'Načítavam...';
        }

        try {
            const response = await fetch('/api/plot', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    location: selectedLocation,
                }),
            });
            const data = await response.json();
            if (!response.ok) {
                throw new Error(data.error || `HTTP error! Status: ${response.status}`);
            }

            // Parse the plot data and render it
            const ndviData = JSON.parse(data.ndvi_data);
            const tempData = JSON.parse(data.temp_data);
            const thresholdDates = JSON.parse(data.threshold_dates);
            renderPlots(ndviData, tempData, thresholdDates);

        } catch (error) {
            console.error('Plot error:', error);
            showError(`Chyba pri generovaní grafu: ${error.message}`);
        } finally {
            if (analyzePolenBtn) {
                analyzePolenBtn.disabled = false;
                analyzePolenBtn.textContent = 'Zobraziť vývoj peľovej sezóny';
            }
        }
    }

    function renderPollenPlots(pollenGraphs){
        const resultsSection = document.getElementById('results austria-graph');
        if (!resultsSection) return;

        resultsSection.innerHTML = `
                <div id="pollen-chart-container" style="width: 100%; height: 500px;"></div>
                `;

        // Pollen Plot Layout
        const pollenLayout = {
            title: 'Aktuálna peľová situácia v tomto roku',
            xaxis: {
                title: 'Dátum',
                type: 'category',
                tickangle: -45,
                nticks: 15
            },
            yaxis: {
                title: 'Koncentrácia peľu',
                range: [0, null]
            },
            hovermode: 'closest',
            paper_bgcolor: 'rgba(0,0,0,0)',
            plot_bgcolor: 'rgba(0,0,0,0)',
            font: {color: '#e5e7eb'},
            legend: {
                orientation: 'v',
                x: 1.02,
                y: 1
            }
        };

        Plotly.newPlot('pollen-chart-container', pollenGraphs, pollenLayout);
    }

    function renderPlots(ndviGraphs, tempGraphs, thresholdDates) {
        const resultsSection = document.getElementById('results');
        if (!resultsSection) return;

        // Create containers for both plots
        resultsSection.innerHTML = `
                <div id="ndvi-chart-container" style="width: 100%; height: 500px; margin-bottom: 30px;"></div>
                <div id="temp-chart-container" style="width: 100%; height: 500px;"></div>
            `;

        // Track which lines are highlighted (shared between both plots)
        let highlightedLines = new Set();

        // NDVI Plot Layout
        const ndviLayout = {
            title: 'NDVI - Porovnanie rokov (kliknite na legendu alebo čiaru pre zvýraznenie)',
            xaxis: {
                title: 'Obdobie',
                type: 'category',
                tickangle: -45,
                nticks: 10
            },
            yaxis: {
                title: 'NDVI',
                range: [0, 1]
            },
            hovermode: 'closest',
            paper_bgcolor: 'rgba(0,0,0,0)',
            plot_bgcolor: 'rgba(0,0,0,0)',
            font: {color: '#e5e7eb'},
            legend: {
                orientation: 'v',
                x: 1.02,
                y: 1
            }
        };

        // Temperature Plot Layout
        const tempLayout = {
            title: 'Teplota - Porovnanie rokov (kliknite na legendu alebo čiaru pre zvýraznenie)',
            xaxis: {
                title: 'Dátum',
                type: 'category',
                tickangle: -45,
                nticks: 15
            },
            yaxis: {
                title: 'Teplota (°C)',
                range: [0, null]
            },
            hovermode: 'closest',
            paper_bgcolor: 'rgba(0,0,0,0)',
            plot_bgcolor: 'rgba(0,0,0,0)',
            font: {color: '#e5e7eb'},
            legend: {
                orientation: 'v',
                x: 1.02,
                y: 1
            }
        };

        // Draw both plots
        Plotly.newPlot('ndvi-chart-container', ndviGraphs, ndviLayout);
        Plotly.newPlot('temp-chart-container', tempGraphs, tempLayout);

        const ndviPlot = document.getElementById('ndvi-chart-container');
        const tempPlot = document.getElementById('temp-chart-container');

        // Add threshold markers to temperature plot as scatter points
        const markerTraces = [];

        // Get the actual rendered colors from the plot
        const renderedData = tempPlot.data;

        Object.entries(thresholdDates).forEach(([yearCol, info], index) => {
            // Find the corresponding line to get its color
            const lineIndex = tempGraphs.findIndex(trace => trace.name === yearCol);
            if (lineIndex === -1) return; // Skip if year not found

            // Get the actual color from the rendered trace
            const lineColor = renderedData[lineIndex].line.color;

            // Create scatter trace for the 5-day period
            const dates = [];
            const values = [];

            // Get the temperature values for the 5-day period
            for (let i = info.start_index; i <= info.end_index; i++) {
                dates.push(tempGraphs[lineIndex].x[i]);
                values.push(tempGraphs[lineIndex].y[i]);
            }

            const markerTrace = {
                x: dates,
                y: values,
                mode: 'markers',
                type: 'scatter',
                name: `${yearCol} - Threshold`,
                marker: {
                    size: 10,
                    color: lineColor,
                    symbol: 'diamond',
                    line: {
                        color: lineColor,
                        width: 2
                    }
                },
                opacity: 0.7,
                showlegend: false,
                hovertemplate: `<b>${yearCol}</b><br>5+ days ≥5°C<br>%{x}<br>%{y:.1f}°C<extra></extra>`
            };

            markerTraces.push(markerTrace);
        });

        // Add marker traces to the temperature plot
        if (markerTraces.length > 0) {
            Plotly.addTraces('temp-chart-container', markerTraces);
        }

        // Function to toggle highlight on both plots
        function toggleHighlight(curveNumber) {
            // Toggle the line
            if (highlightedLines.has(curveNumber)) {
                highlightedLines.delete(curveNumber);
            } else {
                highlightedLines.add(curveNumber);
            }

            updateBothPlots();
        }

        function updateBothPlots() {
            const ndviOpacities = [];
            const ndviWidths = [];
            const tempOpacities = [];
            const tempWidths = [];
            const markerOpacities = [];

            for (let i = 0; i < ndviGraphs.length; i++) {
                if (highlightedLines.has(i)) {
                    // Highlighted lines
                    ndviOpacities.push(1.0);
                    ndviWidths.push(5);
                    tempOpacities.push(1.0);
                    tempWidths.push(5);
                    markerOpacities.push(1.0);
                } else if (highlightedLines.size > 0) {
                    // Non-highlighted lines when at least one is highlighted
                    ndviOpacities.push(0.7);
                    ndviWidths.push(2.5);
                    tempOpacities.push(0.15);
                    tempWidths.push(1.5);
                    markerOpacities.push(0.15); // Match line opacity
                } else {
                    // Default state when nothing is highlighted
                    ndviOpacities.push(0.7);
                    ndviWidths.push(2.5);
                    tempOpacities.push(0.7);
                    tempWidths.push(2.5);
                    markerOpacities.push(0.7); // Match line opacity
                }
            }

            // Update both plots with different opacity values
            // Only update the first N traces (the actual data lines, not markers)
            const traceIndices = [...Array(ndviGraphs.length).keys()];

            Plotly.restyle('ndvi-chart-container', {
                'opacity': ndviOpacities,
                'line.width': ndviWidths
            }, traceIndices);

            Plotly.restyle('temp-chart-container', {
                'opacity': tempOpacities,
                'line.width': tempWidths
            }, traceIndices);

            // Update marker opacities to match their corresponding lines
            const markerIndices = [...Array(markerOpacities.length).keys()].map(i => i + ndviGraphs.length);
            Plotly.restyle('temp-chart-container', {
                'opacity': markerOpacities
            }, markerIndices);
        }

        // NDVI plot event handlers
        ndviPlot.on('plotly_click', function (data) {
            const curveNumber = data.points[0].curveNumber;
            toggleHighlight(curveNumber);
        });

        ndviPlot.on('plotly_legendclick', function (data) {
            const curveNumber = data.curveNumber;
            toggleHighlight(curveNumber);
            return false;
        });

        // Temperature plot event handlers
        tempPlot.on('plotly_click', function (data) {
            const curveNumber = data.points[0].curveNumber;
            toggleHighlight(curveNumber);
        });

        tempPlot.on('plotly_legendclick', function (data) {
            const curveNumber = data.curveNumber;
            toggleHighlight(curveNumber);
            return false;
        });

        // Double click to reset both plots
        ndviPlot.on('plotly_doubleclick', function () {
            highlightedLines.clear();
            const resetOpacities = Array(ndviGraphs.length).fill(0.7);
            const resetWidths = Array(ndviGraphs.length).fill(2.5);
            const traceIndices = [...Array(ndviGraphs.length).keys()];

            Plotly.restyle('ndvi-chart-container', {
                'opacity': resetOpacities,
                'line.width': resetWidths
            }, traceIndices);
            Plotly.restyle('temp-chart-container', {
                'opacity': resetOpacities,
                'line.width': resetWidths
            }, traceIndices);

            // Reset marker opacities to match line opacity
            const markerIndices = [...Array(resetOpacities.length).keys()].map(i => i + ndviGraphs.length);
            Plotly.restyle('temp-chart-container', {
                'opacity': resetOpacities
            }, markerIndices);
        });

        tempPlot.on('plotly_doubleclick', function () {
            highlightedLines.clear();
            const resetOpacities = Array(tempGraphs.length).fill(0.7);
            const resetWidths = Array(tempGraphs.length).fill(2.5);
            const traceIndices = [...Array(tempGraphs.length).keys()];

            Plotly.restyle('ndvi-chart-container', {
                'opacity': resetOpacities,
                'line.width': resetWidths
            }, traceIndices);
            Plotly.restyle('temp-chart-container', {
                'opacity': resetOpacities,
                'line.width': resetWidths
            }, traceIndices);

            // Reset marker opacities to match line opacity
            const markerIndices = [...Array(resetOpacities.length).keys()].map(i => i + tempGraphs.length);
            Plotly.restyle('temp-chart-container', {
                'opacity': resetOpacities
            }, markerIndices);
        });
    }

    async function handleAnalysis() {
        const yearContainer = document.getElementById('year-checkbox-container');
        const seasonSelect = document.getElementById('season-select');
        const resultsSection = document.getElementById('results');
        const analyzeBtn = document.getElementById('analyze-btn');

        const selectedYears = Array.from(yearContainer.querySelectorAll('input[type="checkbox"]:checked'))
                .map(cb => cb.value);
        const selectedSeason = seasonSelect.value;

        if (selectedYears.length < 2) {
            showError("Vyberte prosím aspoň dva roky pre analýzu trendu.");
            return;
        }

        showLoading();
        analyzeBtn.disabled = true;
        analyzeBtn.textContent = 'Spracúvam...';

        try {
            const response = await fetch('/api/analyze', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    years: selectedYears,
                    season: selectedSeason,
                }),
            });
            const data = await response.json();
            if (!response.ok) {
                throw new Error(data.error || `HTTP error! Status: ${response.status}`);
            }
            showImage(data.image_url);
        } catch (error) {
            console.error('Analysis error:', error);
            showError(`Chyba pri analýze: ${error.message}`);
        } finally {
            analyzeBtn.disabled = false;
            analyzeBtn.textContent = 'Analyzovať trend';
        }
    }

    function showLoading() {
        const resultsSection = document.getElementById('results');
        if (resultsSection) {
            resultsSection.innerHTML = '<div class="spinner"></div><p class="placeholder-text" style="margin-top: 10px;">Prebieha analýza, môže to trvať aj viac ako minútu...</p>';
        }
    }

    function showImage(imageUrl) {
        const resultsSection = document.getElementById('results');
        if (resultsSection) {
            const url = `${imageUrl}?t=${new Date().getTime()}`;
            resultsSection.innerHTML = `<img src="${url}" alt="Mapa trendu vegetácie">`;
        }
    }

    function showError(message) {
        const resultsSection = document.getElementById('results');
        if (resultsSection) {
            resultsSection.innerHTML = `<div class="error-message">${message}</div>`;
        }
    }
</script>
</body>
</html>


